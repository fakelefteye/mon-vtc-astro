---
// src/components/BookingForm.astro
---
<div id="booking-container" class="booking-wrapper">
    <h2 class="form-title">Demande de Devis et R√©servation</h2>
    <p class="form-subtitle">Obtenez une estimation et r√©servez votre trajet.</p>

    <form id="quote-form" class="form-grid">
        <div class="form-group full-width"><h3 class="step-title">1. Vos Coordonn√©es</h3></div>
        <div class="form-group"><label for="name">Nom & Pr√©nom</label><input type="text" id="name" name="name" required placeholder="Ex: Marie Dupont"></div>
        <div class="form-group"><label for="email">Adresse E-mail</label><input type="email" id="email" name="email" required placeholder="Pour recevoir le bon de r√©servation"></div>
        <div class="form-group"><label for="phone">T√©l√©phone</label><input type="tel" id="phone" name="phone" required placeholder="Pour vous contacter si besoin"></div>
        <div class="form-group"><label for="passengers">Nombre de passagers</label><input type="number" id="passengers" name="passengers" required min="1" max="4" value="1"></div>

        <div class="form-group full-width"><h3 class="step-title">2. D√©tails du Trajet</h3></div>
        <div class="form-group"><label for="pickup">Adresse de d√©part</label><input type="text" id="pickup" name="pickup" required placeholder="Commencez √† taper une adresse..."></div>
        <div class="form-group"><label for="dropoff">Adresse de destination</label><input type="text" id="dropoff" name="dropoff" required placeholder="Commencez √† taper une adresse..."></div>
        <div class="form-group full-width"><label for="booking-time">Date et heure de la prise en charge</label><input type="datetime-local" id="booking-time" name="bookingTime" required></div>
        <div class="form-group full-width"><label for="specialRequests">Demandes particuli√®res</label><textarea id="specialRequests" name="specialRequests" rows="3" placeholder="Ex: Si√®ge b√©b√©, bagages volumineux..."></textarea></div>

        <div class="form-group full-width">
            <button type="submit" id="estimate-btn" class="cta-button">Estimer le Prix</button>
        </div>
    </form>
    
    <div id="quote-result" class="quote-result-hidden">
        <div id="quote-details"></div>
        <h3 class="payment-title">3. Confirmez votre r√©servation</h3>
        <div class="payment-buttons">
            <button type="button" id="pay-online-btn" class="submit-button cta">üí≥ Payer en ligne</button>
            <button type="button" id="book-onboard-btn" class="secondary-button">üöó R√©server & Payer √† bord</button>
        </div>
        <p id="form-status" class="status-message"></p>
    </div>
</div>

---
<style>
    :root { 
        /* Variables de couleurs ajust√©es pour un bouton "multicolore" */
        --accent-color: #007bff; /* Bleu primaire pour les accents */
        --dark-color: #1a1a1a;

        /* D√©grad√©s pour le bouton "Payer en ligne" (CTA) */
        --cta-bg: linear-gradient(45deg, #007bff, #6f42c1); /* Bleu vers Violet */
        --cta-hover: linear-gradient(45deg, #6f42c1, #e83e8c); /* Violet vers Rose */
        
        /* Vous pouvez ajuster ces couleurs avec vos propres codes HEX
           Exemples de palettes color√©es :
           - Chaud et √©nergique : linear-gradient(45deg, #FF5733, #FFC300); (Orange √† Jaune)
           - Frais et moderne : linear-gradient(45deg, #28a745, #17a2b8); (Vert √† Cyan)
           - Joyeux et ludique : linear-gradient(45deg, #fd7e14, #ffc107); (Orange √† Jaune d'Or)
        */
    }
    .booking-wrapper { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); max-width: 800px; margin: 3rem auto; font-family: 'Montserrat', sans-serif; }
    .form-title { font-size: 2.2em; text-align: center; color: var(--dark-color); }
    .form-subtitle { text-align: center; color: #666; margin: 0.5rem 0 2.5rem 0; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem 2rem; }
    .full-width { grid-column: 1 / -1; }
    .step-title { font-size: 1.2em; color: var(--dark-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; margin: 1rem 0; }
    label { margin-bottom: 0.5rem; font-weight: 600; color: #555; }
    input, textarea { background-color: #fff !important; color: #333 !important; padding: 0.9rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd; }

    /* STYLE G√âN√âRIQUE POUR LES BOUTONS DE SOUMISSION */
    .submit-button { 
        padding: 1rem; 
        font-size: 1.1em; 
        font-weight: bold; 
        color: white; /* Couleur de texte par d√©faut pour submit-button */
        background: var(--dark-color); /* Fond par d√©faut pour submit-button */
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        transition: all 0.3s ease; 
    }
    .submit-button:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
    }

    /* STYLE SP√âCIFIQUE POUR LE BOUTON CTA (PAYER EN LIGNE) */
    /* Ces r√®gles sont d√©j√† plus sp√©cifiques, mais j'ajoute !important pour forcer si n√©cessaire */
    .submit-button.cta { 
        background: var(--cta-bg) !important; /* Utilise le d√©grad√© d√©fini dans :root */
        color: white !important; /* Re-sp√©cifie la couleur blanche */
    }
    .submit-button.cta:hover { 
        background: var(--cta-hover) !important; /* Utilise le d√©grad√© de survol */
    }

    .secondary-button { padding: 1rem; font-size: 1.1em; font-weight: bold; color: var(--dark-color); background: #f1f3f5; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .secondary-button:hover { background: #e9ecef; transform: translateY(-2px); }

    .quote-result-hidden { display: none; }
    .quote-result-visible { display: block; margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #eee; text-align: center; }
    #quote-details .price { font-size: 1.8em; font-weight: bold; color: var(--accent-color); margin-top: 1rem; }
    .payment-title { font-size: 1.2em; margin: 2rem 0 1rem 0; }
    .payment-buttons { display: flex; flex-direction: column; gap: 1rem; }
    .status-message { text-align: center; font-weight: 500; min-height: 24px; margin-top: 1.5rem; }
    .error { color: #d9534f; }

    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
</style>
<script>
    import type { Stripe } from '@stripe/stripe-js';

    // On englobe tout dans un seul √©couteur d'√©v√©nement pour la stabilit√©.
    document.addEventListener('DOMContentLoaded', () => {
        
        let bookingData = {};
        let stripe: Stripe | null = null;

        // --- S√âLECTION DES √âL√âMENTS DU DOM ---
        const quoteForm = document.getElementById('quote-form') as HTMLFormElement;
        const quoteResultEl = document.getElementById('quote-result') as HTMLDivElement;
        const quoteDetailsEl = document.getElementById('quote-details') as HTMLDivElement;
        const payOnlineBtn = document.getElementById('pay-online-btn') as HTMLButtonElement;
        const bookOnboardBtn = document.getElementById('book-onboard-btn') as HTMLButtonElement;
        const statusEl = document.getElementById('form-status') as HTMLParagraphElement;
        
        // --- INITIALISATION DES SCRIPTS EXTERNES ---
        
        function initStripe() {
            const stripePublishableKey = import.meta.env.PUBLIC_STRIPE_KEY;
            if (window.Stripe && stripePublishableKey) {
                stripe = window.Stripe(stripePublishableKey);
                console.log("‚úÖ Stripe est pr√™t !");
            } else {
                console.error("‚ùå La cl√© publique Stripe ou Stripe.js est manquant(e).");
            }
        }
        
        function initAutocomplete() {
            const pickupInput = document.getElementById('pickup');
            const dropoffInput = document.getElementById('dropoff');
            if (pickupInput && dropoffInput && window.google) {
                const options = {
                    componentRestrictions: { country: 'fr' },
                    fields: ["formatted_address"],
                };
                new window.google.maps.places.Autocomplete(pickupInput as HTMLInputElement, options);
                new window.google.maps.places.Autocomplete(dropoffInput as HTMLInputElement, options);
                console.log("‚úÖ Autocomplete initialis√© !");
            }
        }
        
        // On √©coute les signaux du Layout pour initialiser
        window.addEventListener('stripe-loaded', initStripe);
        window.addEventListener('maps-loaded', initAutocomplete);

        // On v√©rifie aussi si les scripts ne sont pas d√©j√† charg√©s (pour les retours en arri√®re)
        if (window.Stripe) initStripe();
        if (window.google?.maps?.places) initAutocomplete();

        // --- GESTION DES √âV√âNEMENTS DU FORMULAIRE ---
        
        quoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            quoteDetailsEl.innerHTML = 'Calcul en cours...';
            quoteResultEl.className = 'quote-result-visible';
            statusEl.textContent = '';
            
            const data = Object.fromEntries(new FormData(quoteForm).entries());
            try {
                const response = await fetch('/api/quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pickup: data.pickup, 
                        dropoff: data.dropoff,
                        bookingTime: data.bookingTime 
                    }),
                });
                const quote = await response.json();
                if (!response.ok) throw new Error(quote.message || "Erreur de calcul.");
                
                quoteDetailsEl.innerHTML = `<p class="price">Prix estim√© : ${quote.price.toFixed(2)} ‚Ç¨</p>`;
                bookingData = { ...data, ...quote };
            } catch(error) {
                quoteDetailsEl.innerHTML = `<p class="error">${error instanceof Error ? error.message : "Erreur inconnue"}</p>`;
            }
        });

        payOnlineBtn.addEventListener('click', async () => {
            if (!stripe) { 
                statusEl.textContent = "Le service de paiement n'est pas pr√™t. Veuillez rafra√Æchir la page.";
                statusEl.className = 'status-message error';
                return;
            }
            statusEl.textContent = "Pr√©paration du paiement...";
            try {
                const response = await fetch('/api/create-stripe-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData),
                });
                const session = await response.json();
                if (session.id) {
                    await stripe.redirectToCheckout({ sessionId: session.id });
                } else {
                    throw new Error("ID de session manquant.");
                }
            } catch (error) {
                statusEl.textContent = `Erreur de paiement : ${error instanceof Error ? error.message : "Inconnue"}`;
                statusEl.className = 'status-message error';
            }
        });

        bookOnboardBtn.addEventListener('click', async () => {
            statusEl.textContent = 'Enregistrement de la r√©servation...';
            try {
                const response = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData),
                });
                if (!response.ok) throw new Error("La r√©servation a √©chou√©.");
                window.location.href = '/confirmation';
            } catch(error) {
                statusEl.textContent = `Erreur : ${error instanceof Error ? error.message : "Inconnue"}`;
                statusEl.className = 'status-message error';
            }
        });
    });
</script>